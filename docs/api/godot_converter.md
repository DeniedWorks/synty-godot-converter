# Godot Converter API Reference

## Overview

The `godot_converter.gd` script extracts individual meshes from FBX files and saves them as `.tscn` or `.res` scene files with materials applied as external references. This enables Synty assets to be used as individual mesh scenes in Godot projects with proper material assignments.

**Key Features:**
- Converts FBX files to individual `.tscn` or `.res` mesh scenes
- Supports combined scene mode (all meshes from one FBX in a single scene)
- Applies materials from pre-generated `.tres` files
- Materials are external references (not baked in)
- Handles collision meshes with green wireframe debug material
- Preserves directory structure from source FBX files
- Handles duplicate mesh names across FBX files
- Supports FBX filename filtering for selective conversion

**Script Location:** `godot_converter.gd`

---

## Running the Script

The script runs in Godot's headless mode (no GUI) for batch processing:

```bash
# Basic execution
godot --headless --script res://godot_converter.gd

# With specific Godot path (Windows example)
C:\Godot\Godot_v4.6-stable_mono_win64\Godot_v4.6-stable_mono_win64.exe --headless --script res://godot_converter.gd

# From project directory
cd my_godot_project
godot --headless --script res://godot_converter.gd
```

**Prerequisites:**
- Godot 4.x installed
- Script must be run from within a valid Godot project
- Input files must be in place before running

---

## Expected Input Files

The script expects a specific directory structure:

```
project_root/
    godot_converter.gd          # This script
    converter_config.json       # Configuration options (optional)
    shaders/
        mesh_material_mapping.json  # Mesh-to-material mappings (required)
    {PackName}/                 # Pack folder(s)
        models/                     # FBX files to convert (required)
            *.fbx
            subfolder/
                *.fbx
        materials/                  # Pre-generated .tres materials (required)
            MaterialName.tres
            ...
```

### converter_config.json

Optional JSON configuration file generated by the Python CLI. Controls conversion behavior.

```json
{
  "keep_meshes_together": false,
  "mesh_format": "tscn",
  "filter_pattern": null
}
```

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `keep_meshes_together` | `bool` | `false` | Keep all meshes from one FBX in a single scene file |
| `mesh_format` | `string` | `"tscn"` | Output format: `"tscn"` (text) or `"res"` (binary) |
| `filter_pattern` | `string` | `null` | Only process FBX files containing this pattern (case-insensitive) |

### mesh_material_mapping.json

JSON file mapping mesh names to arrays of material names. Generated by the Python `material_list` module.

```json
{
  "SM_Env_Tree_01_LOD0": ["Tree_Trunk_Mat", "Tree_Leaves_Mat"],
  "SM_Env_Tree_01_LOD1": ["Tree_Trunk_Mat", "Tree_Leaves_Mat"],
  "SM_Prop_Rock_01": ["Rock_Mat"]
}
```

**Format:**
- Keys: Mesh names (must match MeshInstance3D node names in FBX)
- Values: Arrays of material names in surface order

### models/ Directory

Contains FBX files to be converted. Subdirectory structure is preserved in output.

### materials/ Directory

Contains pre-generated `.tres` ShaderMaterial files. Filenames must match material names from the mapping (e.g., `Tree_Trunk_Mat.tres`).

---

## Output Structure

The script outputs to `res://{PackName}/meshes/`:

```
{PackName}/
    meshes/
        SM_Env_Tree_01_LOD0.tscn  # or .res based on mesh_format
        SM_Env_Tree_01_LOD1.tscn
        SM_Prop_Rock_01.tscn
        subfolder/                   # Mirrors models/ structure
            SM_Env_Bush_01.tscn
```

### Scene Structure (Individual Meshes - Default)

Each output scene contains a single `MeshInstance3D` root node:

```gdscript
# Scene structure (conceptual)
MeshInstance3D (root)
    name = "SM_Env_Tree_01_LOD0"
    mesh = <imported mesh resource>
    surface_override_material/0 = ExtResource("Tree_Trunk_Mat.tres")
    surface_override_material/1 = ExtResource("Tree_Leaves_Mat.tres")
```

### Scene Structure (Combined - with --keep-meshes-together)

When `keep_meshes_together` is enabled, each output scene contains all meshes from the source FBX:

```gdscript
# Combined scene structure (conceptual)
Node3D (root)
    name = "SM_Env_Tree_01"  # FBX filename
    MeshInstance3D
        name = "SM_Env_Tree_01_LOD0"
        mesh = <imported mesh resource>
        surface_override_material/0 = ExtResource("Tree_Trunk_Mat.tres")
    MeshInstance3D
        name = "SM_Env_Tree_01_LOD1"
        ...
```

**Key Points:**
- Materials are external references, not embedded
- Mesh resource is referenced from the original FBX import
- Default: One scene per MeshInstance3D found in source FBX
- With `--keep-meshes-together`: One scene per FBX file

---

## Functions

### load_converter_config() -> bool

Loads configuration options from `converter_config.json`.

**Returns:** `bool` - `true` if config loaded successfully (or defaults used), `false` on parse error

**Expected Path:** `res://converter_config.json`

**Behavior:**
- If file doesn't exist, uses defaults (no error)
- Parses JSON and populates config variables
- Logs loaded config values

**Configuration Options:**
- `keep_meshes_together` - Save all meshes from one FBX together
- `mesh_format` - Output format (`tscn` or `res`)
- `filter_pattern` - Filter pattern for FBX filenames

---

### _init() -> void

Main entry point. Called automatically when script runs.

**Behavior:**
1. Initializes collision material (green wireframe)
2. Loads converter configuration from JSON
3. Loads material mapping JSON
4. Discovers pack folders (directories with models/ and materials/)
5. For each pack folder:
   - Finds all FBX files in `{pack}/models/`
   - Processes each FBX file (applying filter if set)
   - Saves scenes to `{pack}/meshes/`
6. Prints summary and exits

**Exit Codes:**
- `0` - Success (at least one mesh saved)
- `1` - Failure (no meshes saved or config/mapping load failed)

---

### load_material_mapping() -> bool

Parses the `mesh_material_mapping.json` file.

**Returns:** `bool` - `true` on success, `false` on failure

**Expected Path:** `res://mesh_material_mapping.json`

**Behavior:**
- Validates file exists
- Parses JSON content
- Validates data is a Dictionary
- Populates `mesh_to_materials` class variable

**Error Conditions:**
- File not found
- File cannot be opened
- JSON parse error
- Data is not a Dictionary

---

### find_fbx_files(directory: String) -> Array[String]

Recursively discovers all FBX files in the given directory.

**Arguments:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `directory` | `String` | Directory path to search (e.g., `"res://PackName/models"`) |

**Returns:** `Array[String]` - Array of full paths to FBX files

**Behavior:**
- Recursively searches subdirectories
- Skips hidden directories (starting with `.`)
- Case-insensitive `.fbx` extension matching
- Applies `config_filter_pattern` if set (case-insensitive substring match)
- Returns empty array if directory cannot be opened

**Filter Example:**
If `config_filter_pattern = "Tree"`, only FBX files with "tree" (case-insensitive) in the filename are returned

---

### process_fbx_file(fbx_path: String) -> void

Converts a single FBX file by extracting meshes based on configuration.

**Arguments:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `fbx_path` | `String` | Full path to the FBX file |

**Behavior:**
1. Loads FBX as PackedScene
2. Instantiates scene for traversal
3. Finds all MeshInstance3D nodes
4. Based on `config_keep_meshes_together`:
   - If `true`: Calls `save_fbx_as_single_scene()` to save all meshes in one scene
   - If `false`: Extracts and saves each mesh individually
5. Frees instantiated scene

**Output Directory:**
Mirrors the relative path from `models/` in `meshes/`:
- `res://PackName/models/props/rock.fbx` -> `res://PackName/meshes/props/`

---

### save_fbx_as_single_scene(scene_root: Node, mesh_instances: Array[MeshInstance3D], relative_dir: String, fbx_name: String) -> void

Saves all meshes from an FBX as a single combined scene file.

**Arguments:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `scene_root` | `Node` | Root node of the FBX scene |
| `mesh_instances` | `Array[MeshInstance3D]` | Array of mesh instances to process |
| `relative_dir` | `String` | Relative directory for output |
| `fbx_name` | `String` | Name of the FBX file (used as scene name) |

**Behavior:**
1. Applies materials to each mesh instance
2. Creates a new Node3D root with all children
3. Sets ownership recursively for proper PackedScene packing
4. Saves using the configured mesh format (`.tscn` or `.res`)

**Use Case:**
When `--keep-meshes-together` is enabled, this preserves the FBX's original hierarchy instead of extracting individual meshes

---

### find_mesh_instances(node: Node) -> Array[MeshInstance3D]

Recursively finds all MeshInstance3D nodes in a scene tree.

**Arguments:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `node` | `Node` | Root node to search from |

**Returns:** `Array[MeshInstance3D]` - Array of all MeshInstance3D nodes found

**Behavior:**
- Depth-first traversal
- Includes the root node if it's a MeshInstance3D
- Returns nodes in tree order

---

### extract_and_save_mesh(mesh_instance: MeshInstance3D, relative_dir: String, fbx_name: String) -> void

Extracts a mesh from a MeshInstance3D and saves it as a `.tscn` scene file.

**Arguments:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `mesh_instance` | `MeshInstance3D` | The mesh instance to extract |
| `relative_dir` | `String` | Relative directory for output (from models/) |
| `fbx_name` | `String` | Source FBX filename (without extension) |

**Behavior:**

1. **Validation:**
   - Skips if mesh is null
   - Skips if mesh has no surfaces

2. **Collision Detection:**
   - Detects collision meshes by name (`collision` or `_col` suffix)
   - Applies magenta StandardMaterial3D for visibility
   - Saves immediately without material lookup

3. **Material Application:**
   - Looks up materials in mapping
   - Loads each `.tres` file from `res://materials/`
   - Applies as surface override materials

4. **Duplicate Handling:**
   - Appends FBX name if mesh name already saved
   - Example: `SM_Rock_01.tscn` -> `SM_Rock_01_Props.tscn`

5. **Save:**
   - Packs node as PackedScene
   - Saves to output path

---

### get_material_names_for_mesh(mesh_name: String) -> Array[String]

Looks up material names for a mesh, handling Godot's numeric suffixes.

**Arguments:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `mesh_name` | `String` | Name of the mesh to look up |

**Returns:** `Array[String]` - Array of material names (may contain empty strings for unmapped surfaces)

**Lookup Strategy:**
1. Try exact match first
2. Strip numeric suffixes (`_001`, `_01`, `001`) and retry
3. Return empty array if no match found

**Examples:**
- `SM_Tree_01` - exact match
- `SM_Tree_01_001` - strips `_001`, matches `SM_Tree_01`

---

### _strip_numeric_suffix(name: String) -> String

Strips trailing numeric suffixes from a mesh name.

**Arguments:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `name` | `String` | Mesh name to process |

**Returns:** `String` - Name with numeric suffix removed

**Pattern:** Removes `_001`, `_01`, `001` etc. from end of string

**Examples:**
```gdscript
_strip_numeric_suffix("SM_Tree_01_001")  # -> "SM_Tree_01"
_strip_numeric_suffix("Mesh_002")         # -> "Mesh"
_strip_numeric_suffix("SM_Rock")          # -> "SM_Rock" (unchanged)
```

---

### _ensure_directory_exists(dir_path: String) -> void

Creates a directory if it doesn't exist.

**Arguments:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `dir_path` | `String` | Directory path to create |

**Behavior:**
- No-op if directory already exists
- Creates parent directories recursively
- Logs warning on failure

---

### print_summary() -> void

Prints final conversion statistics.

**Output Format:**
```
============================================================
Conversion Complete
============================================================
  Output format:  .tscn
  Mode:           Individual meshes
  Meshes saved:   42
  Meshes skipped: 3
  Warnings:       7
  Errors:         0
============================================================

All meshes converted successfully!
```

**Mode Output:**
- `Individual meshes` - Default mode, one scene per mesh
- `Combined scenes (one per FBX)` - When `--keep-meshes-together` is enabled

---

## Class Variables

| Variable | Type | Description |
|----------|------|-------------|
| `mesh_to_materials` | `Dictionary` | Mesh name to material array mapping |
| `saved_mesh_names` | `Dictionary` | Tracks saved paths to detect duplicates |
| `meshes_saved` | `int` | Counter for successfully saved meshes |
| `meshes_skipped` | `int` | Counter for skipped meshes (null/no surfaces) |
| `warnings` | `int` | Counter for non-fatal issues |
| `errors` | `int` | Counter for fatal errors |
| `collision_material` | `StandardMaterial3D` | Green wireframe material for collision meshes |
| `current_pack_folder` | `String` | Current pack folder being processed |
| `default_material_name` | `String` | Default material name for current pack |
| `config_keep_meshes_together` | `bool` | If true, save all meshes from one FBX in a single scene |
| `config_mesh_format` | `String` | Output format: `"tscn"` or `"res"` |
| `config_filter_pattern` | `String` | Filter pattern for FBX filenames |

---

## Error Handling

### Error Types

| Error | Cause | Handling |
|-------|-------|----------|
| Mapping not found | `mesh_material_mapping.json` missing | Aborts with exit code 1 |
| FBX load failure | Corrupt or unsupported FBX | Logs error, continues to next file |
| Scene instantiation failure | Memory or format issue | Logs error, continues |
| Material not found | `.tres` file missing | Logs warning, continues without material |
| Pack/Save failure | Disk or permission issue | Logs error, continues |

### Warning vs Error

- **Warning:** Non-fatal, mesh still saved (e.g., missing material)
- **Error:** Fatal for that mesh, not saved (e.g., pack failure)

### Exit Codes

| Code | Meaning |
|------|---------|
| 0 | At least one mesh saved successfully |
| 1 | No meshes saved (complete failure) |

Warnings do not affect exit code - they are expected in normal operation.

---

## Collision Mesh Handling

Meshes with names containing `collision` (case-insensitive) or ending with `_col` are treated specially:

1. No material lookup performed
2. Magenta unshaded material applied (for visibility in editor)
3. Saved immediately

**Collision Material:**
```gdscript
collision_material = StandardMaterial3D.new()
collision_material.albedo_color = Color(1.0, 0.0, 1.0)  # Magenta
collision_material.shading_mode = BaseMaterial3D.SHADING_MODE_UNSHADED
```

This makes collision meshes easily visible during development while clearly distinguishing them from rendered geometry.

---

## Complete Example

### Setup

```
project/
    godot_converter.gd
    mesh_material_mapping.json
    models/
        props/
            SM_Prop_Rock_01.fbx
        environment/
            SM_Env_Tree_01.fbx
    materials/
        Rock_Mat.tres
        Tree_Trunk_Mat.tres
        Tree_Leaves_Mat.tres
```

### mesh_material_mapping.json

```json
{
  "SM_Prop_Rock_01": ["Rock_Mat"],
  "SM_Env_Tree_01_LOD0": ["Tree_Trunk_Mat", "Tree_Leaves_Mat"],
  "SM_Env_Tree_01_LOD1": ["Tree_Trunk_Mat", "Tree_Leaves_Mat"]
}
```

### Run

```bash
godot --headless --script res://godot_converter.gd
```

### Output

```
============================================================
Synty Shader Converter - FBX to Scene Files (.tscn)
============================================================

Loaded material mapping with 3 mesh entries
Found 2 FBX file(s) to process

Processing: res://models/props/SM_Prop_Rock_01.fbx
  Found 1 mesh(es)
    Saved: SM_Prop_Rock_01.tscn (1 materials)

Processing: res://models/environment/SM_Env_Tree_01.fbx
  Found 2 mesh(es)
    Saved: SM_Env_Tree_01_LOD0.tscn (2 materials)
    Saved: SM_Env_Tree_01_LOD1.tscn (2 materials)

============================================================
Conversion Complete
============================================================
  Meshes saved:   3
  Meshes skipped: 0
  Warnings:       0
  Errors:         0
============================================================

All meshes converted successfully!
```

### Result

```
meshes/
    props/
        SM_Prop_Rock_01.tscn
    environment/
        SM_Env_Tree_01_LOD0.tscn
        SM_Env_Tree_01_LOD1.tscn
```

---

## Integration with Python Pipeline

The GDScript converter is designed to work with the Python conversion pipeline:

1. **Python: `material_list.py`** - Parses `MaterialList.txt` -> `mesh_material_mapping.json`
2. **Python: `tres_generator.py`** - Generates `.tres` material files
3. **GDScript: `godot_converter.gd`** - Converts FBX -> `.tscn` with materials

See the main [Converter API Reference](converter.md) for the full pipeline documentation.
