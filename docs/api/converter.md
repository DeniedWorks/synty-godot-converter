# Converter Module API

The `converter` module is the main CLI entry point and pipeline orchestrator for the Synty Shader Converter.

## Module Location

```
synty-converter-BLUE/converter.py
```

## Usage

### Command Line

```bash
python converter.py \
    --unity-package "path/to/.unitypackage" \
    --source-files "path/to/SourceFiles" \
    --output "path/to/output" \
    --godot "path/to/Godot.exe" \
    --dry-run \
    --verbose
```

### Programmatic

```python
from converter import ConversionConfig, run_conversion
from pathlib import Path

config = ConversionConfig(
    unity_package=Path("package.unitypackage"),
    source_files=Path("SourceFiles"),
    output_dir=Path("output"),
    godot_exe=Path("godot.exe")
)

stats = run_conversion(config)
```

---

## Classes

### ConversionConfig

Configuration dataclass for the conversion pipeline.

```python
@dataclass
class ConversionConfig:
    unity_package: Path
    source_files: Path
    output_dir: Path
    godot_exe: Path
    dry_run: bool = False
    verbose: bool = False
    skip_fbx_copy: bool = False
    skip_godot_cli: bool = False
    godot_timeout: int = 600
```

#### Attributes

| Attribute | Type | Default | Description |
|-----------|------|---------|-------------|
| `unity_package` | `Path` | required | Path to Unity `.unitypackage` file |
| `source_files` | `Path` | required | Path to `SourceFiles` folder containing `Textures/` and `FBX/` |
| `output_dir` | `Path` | required | Output directory for the generated Godot project |
| `godot_exe` | `Path` | required | Path to Godot 4.6 executable |
| `dry_run` | `bool` | `False` | Preview without writing files |
| `verbose` | `bool` | `False` | Enable verbose/debug logging |
| `skip_fbx_copy` | `bool` | `False` | Skip copying FBX files (use if `models/` already populated) |
| `skip_godot_cli` | `bool` | `False` | Skip running Godot CLI (generates materials only, no `.tscn` scenes) |
| `godot_timeout` | `int` | `600` | Timeout for Godot CLI operations in seconds |

#### Example

```python
config = ConversionConfig(
    unity_package=Path("C:/SyntyComplete/PolygonNature/Nature.unitypackage"),
    source_files=Path("C:/SyntyComplete/PolygonNature/SourceFiles"),
    output_dir=Path("C:/Godot/Projects/converted_nature"),
    godot_exe=Path("C:/Godot/Godot_v4.6.exe"),
    dry_run=True,   # Preview only
    verbose=True,   # Show debug output
    skip_fbx_copy=False,
    skip_godot_cli=False,
    godot_timeout=900  # 15 minute timeout
)
```

---

### ConversionStats

Statistics dataclass collected during conversion.

```python
@dataclass
class ConversionStats:
    materials_parsed: int = 0
    materials_generated: int = 0
    textures_copied: int = 0
    textures_missing: int = 0
    shaders_copied: int = 0
    fbx_copied: int = 0
    fbx_skipped: int = 0
    meshes_converted: int = 0
    godot_import_success: bool = False
    godot_convert_success: bool = False
    godot_timeout_occurred: bool = False
    warnings: list[str] = field(default_factory=list)
    errors: list[str] = field(default_factory=list)
```

#### Attributes

| Attribute | Type | Description |
|-----------|------|-------------|
| `materials_parsed` | `int` | Number of Unity materials successfully parsed |
| `materials_generated` | `int` | Number of Godot `.tres` materials generated |
| `textures_copied` | `int` | Number of texture files copied |
| `textures_missing` | `int` | Number of textures that could not be found |
| `shaders_copied` | `int` | Number of shader files copied |
| `fbx_copied` | `int` | Number of FBX files copied |
| `fbx_skipped` | `int` | Number of FBX files skipped (already existed) |
| `meshes_converted` | `int` | Number of `.tscn` scene files generated by Godot |
| `godot_import_success` | `bool` | Whether Godot import phase succeeded |
| `godot_convert_success` | `bool` | Whether Godot converter script succeeded |
| `godot_timeout_occurred` | `bool` | Whether Godot CLI timed out |
| `warnings` | `list[str]` | List of warning messages |
| `errors` | `list[str]` | List of error messages |

#### Example

```python
stats = run_conversion(config)

print(f"Parsed: {stats.materials_parsed}")
print(f"Generated: {stats.materials_generated}")

if stats.errors:
    print("Errors occurred:")
    for error in stats.errors:
        print(f"  - {error}")
```

---

## Functions

### run_conversion

Execute the full conversion pipeline. This is the main entry point for programmatic usage.

```python
def run_conversion(config: ConversionConfig) -> ConversionStats
```

#### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `config` | `ConversionConfig` | Conversion configuration |

#### Returns

`ConversionStats` with results and any warnings/errors.

#### Pipeline Steps

1. Validate inputs
2. Create output directory structure
3. Extract Unity package
4. Parse all `.mat` files
5. Detect shaders and map properties
6. Generate `.tres` files
7. Copy `.gdshader` files
8. Copy required textures
9. Copy FBX files (unless `skip_fbx_copy=True`)
10. Parse `MaterialList*.txt` (if exists)
11. Generate `mesh_material_mapping.json`
12. Generate `project.godot` with global shader uniforms
13. Run Godot CLI (unless `skip_godot_cli=True`)

#### Example

```python
from converter import ConversionConfig, run_conversion
from pathlib import Path

config = ConversionConfig(
    unity_package=Path("package.unitypackage"),
    source_files=Path("SourceFiles"),
    output_dir=Path("output"),
    godot_exe=Path("godot.exe")
)

stats = run_conversion(config)

if stats.errors:
    print(f"Conversion completed with {len(stats.errors)} errors")
else:
    print(f"Success! Generated {stats.materials_generated} materials")
```

---

### parse_args

Parse command-line arguments and validate inputs.

```python
def parse_args() -> ConversionConfig
```

#### Returns

`ConversionConfig` with validated paths.

#### Raises

- `SystemExit` - If required arguments are missing or invalid

#### CLI Arguments

| Argument | Required | Description |
|----------|----------|-------------|
| `--unity-package` | Yes | Path to Unity `.unitypackage` file |
| `--source-files` | Yes | Path to `SourceFiles` folder |
| `--output` | Yes | Output directory for Godot project |
| `--godot` | Yes | Path to Godot 4.6 executable |
| `--dry-run` | No | Preview without writing files |
| `--verbose` | No | Enable verbose logging |
| `--skip-fbx-copy` | No | Skip copying FBX files |
| `--skip-godot-cli` | No | Skip running Godot CLI |
| `--godot-timeout` | No | Timeout for Godot CLI (default: 600s) |

---

### setup_output_directories

Create the output directory structure.

```python
def setup_output_directories(output_dir: Path, dry_run: bool) -> None
```

#### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `output_dir` | `Path` | Root output directory |
| `dry_run` | `bool` | If `True`, only log what would be created |

#### Created Directories

```
output_dir/
    shaders/
    textures/
    materials/
    models/
    meshes/
```

---

### copy_shaders

Copy `.gdshader` files from the project's `shaders/` directory to output.

```python
def copy_shaders(source_dir: Path, output_dir: Path, dry_run: bool) -> int
```

#### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `source_dir` | `Path` | Directory containing the converter project |
| `output_dir` | `Path` | Output directory (shaders copied to `output_dir/shaders/`) |
| `dry_run` | `bool` | If `True`, only log what would be copied |

#### Returns

Number of shader files copied (or would be copied in dry run).

---

### copy_textures

Copy required texture files from `SourceFiles/Textures` to output.

```python
def copy_textures(
    source_textures: Path,
    output_textures: Path,
    required: set[str],
    dry_run: bool
) -> tuple[int, int]
```

#### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `source_textures` | `Path` | Source textures directory |
| `output_textures` | `Path` | Destination textures directory |
| `required` | `set[str]` | Set of texture names (without extensions) to copy |
| `dry_run` | `bool` | If `True`, only log what would be copied |

#### Returns

Tuple of `(textures_copied, textures_missing)`.

---

### copy_fbx_files

Copy FBX files from `SourceFiles/FBX` to output, preserving directory structure.

```python
def copy_fbx_files(
    source_fbx_dir: Path,
    output_models_dir: Path,
    dry_run: bool
) -> tuple[int, int]
```

#### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `source_fbx_dir` | `Path` | Path to `SourceFiles/FBX` directory |
| `output_models_dir` | `Path` | Path to `output/models` directory |
| `dry_run` | `bool` | If `True`, only log what would be copied |

#### Returns

Tuple of `(fbx_copied, fbx_skipped)`. Files are skipped if they already exist with the same size.

---

### run_godot_cli

Run Godot CLI in two phases: import and convert.

```python
def run_godot_cli(
    godot_exe: Path,
    project_dir: Path,
    timeout_seconds: int,
    dry_run: bool
) -> tuple[bool, bool, bool]
```

#### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `godot_exe` | `Path` | Path to Godot 4.6 executable |
| `project_dir` | `Path` | Path to the Godot project directory |
| `timeout_seconds` | `int` | Maximum time for each phase |
| `dry_run` | `bool` | If `True`, only log what would be executed |

#### Returns

Tuple of `(import_success, convert_success, timeout_occurred)`.

#### Phases

1. **Import Phase**: `godot --headless --import` - Imports FBX files into Godot
2. **Convert Phase**: `godot --headless --script res://godot_converter.gd` - Converts to `.tscn`

---

## Constants

### SHADER_FILES

List of shader files copied to output.

```python
SHADER_FILES = [
    "clouds.gdshader",
    "crystal.gdshader",
    "foliage.gdshader",
    "particles.gdshader",
    "polygon.gdshader",
    "skydome.gdshader",
    "water.gdshader",
]
```

### TEXTURE_EXTENSIONS

Supported texture file extensions.

```python
TEXTURE_EXTENSIONS = [".png", ".tga", ".jpg", ".jpeg", ".PNG", ".TGA", ".JPG", ".JPEG"]
```

### PROJECT_GODOT_TEMPLATE

Template for generated `project.godot` file with global shader uniforms.

```python
PROJECT_GODOT_TEMPLATE = """; Engine configuration file.
; Generated by Synty Shader Converter

[application]
config/name="Synty Converted Assets"
config/features=PackedStringArray("4.6")

[shader_globals]
WindDirection={...}
WindIntensity={...}
GaleStrength={...}
MainLightDirection={...}
SkyColor={...}
EquatorColor={...}
GroundColor={...}
OceanWavesGradient={...}
"""
```

---

## Complete Example

```python
#!/usr/bin/env python3
"""Example: Convert a Synty asset pack."""

import logging
from pathlib import Path
from converter import ConversionConfig, run_conversion

# Enable verbose logging
logging.basicConfig(
    level=logging.DEBUG,
    format="%(levelname)s: %(message)s"
)

# Configure the conversion
config = ConversionConfig(
    unity_package=Path("C:/SyntyComplete/PolygonNature/Nature.unitypackage"),
    source_files=Path("C:/SyntyComplete/PolygonNature/SourceFiles"),
    output_dir=Path("C:/Godot/Projects/converted_nature"),
    godot_exe=Path("C:/Godot/Godot_v4.6.exe"),
    dry_run=False,
    verbose=True,
    skip_fbx_copy=False,
    skip_godot_cli=False,
    godot_timeout=900
)

# Run the conversion
stats = run_conversion(config)

# Report results
print(f"\nConversion Summary:")
print(f"  Materials: {stats.materials_generated}/{stats.materials_parsed}")
print(f"  Textures: {stats.textures_copied} copied, {stats.textures_missing} missing")
print(f"  FBX: {stats.fbx_copied} copied, {stats.fbx_skipped} skipped")
print(f"  Meshes: {stats.meshes_converted}")

if stats.warnings:
    print(f"\nWarnings ({len(stats.warnings)}):")
    for w in stats.warnings[:5]:
        print(f"  - {w}")

if stats.errors:
    print(f"\nErrors ({len(stats.errors)}):")
    for e in stats.errors:
        print(f"  - {e}")
    exit(1)
```
